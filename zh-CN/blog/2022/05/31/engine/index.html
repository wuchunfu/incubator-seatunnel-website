<!doctype html>
<html lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Apache SeaTunnel RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Apache SeaTunnel Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/user_cases/rss.xml" title="Apache SeaTunnel RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/user_cases/atom.xml" title="Apache SeaTunnel Atom Feed">
<script src="https://hm.baidu.com/hm.js?33a9aab233e1082f91e4e347ad716701" async></script><title data-rh="true">Apache SeaTunnel 与计算引擎的解耦之道，重构API我们做了些什么 | Apache SeaTunnel</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://seatunnel.apache.org/zh-CN/blog/2022/05/31/engine"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Apache SeaTunnel 与计算引擎的解耦之道，重构API我们做了些什么 | Apache SeaTunnel"><meta data-rh="true" name="description" content="Apache SeaTunnel (Incubating) 与 Apache Inlong (Incubating) 的5月联合Meetup中，第二位分享的嘉宾是来自白鲸开源的高级工程师李宗文。在使用Apache SeaTunnel (Incubating) 的过程中，他发现了 Apache SeaTunnel (Incubating) 存在的四大问题：Connector实现次数多、参数不统一、难以支持多个版本的引擎以及引擎升级难的问题。为了解决以上的难题，李宗文将目标放在将Apache SeaTunnel (Incubating)与计算引擎进行解耦，重构其中Source与Sink API，实现改良了开发体验。"><meta data-rh="true" property="og:description" content="Apache SeaTunnel (Incubating) 与 Apache Inlong (Incubating) 的5月联合Meetup中，第二位分享的嘉宾是来自白鲸开源的高级工程师李宗文。在使用Apache SeaTunnel (Incubating) 的过程中，他发现了 Apache SeaTunnel (Incubating) 存在的四大问题：Connector实现次数多、参数不统一、难以支持多个版本的引擎以及引擎升级难的问题。为了解决以上的难题，李宗文将目标放在将Apache SeaTunnel (Incubating)与计算引擎进行解耦，重构其中Source与Sink API，实现改良了开发体验。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-05-31T00:00:00.000Z"><link data-rh="true" rel="icon" href="/zh-CN/image/favicon.ico"><link data-rh="true" rel="canonical" href="https://seatunnel.apache.org/zh-CN/blog/2022/05/31/engine"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/blog/2022/05/31/engine" hreflang="en"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/zh-CN/blog/2022/05/31/engine" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/blog/2022/05/31/engine" hreflang="x-default"><link rel="stylesheet" href="/zh-CN/assets/css/styles.04990753.css">
<link rel="preload" href="/zh-CN/assets/js/runtime~main.b2c68a42.js" as="script">
<link rel="preload" href="/zh-CN/assets/js/main.63c98135.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="/zh-CN/image/logo.png" alt="Apache SeaTunnel Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/zh-CN/image/logo.png" alt="Apache SeaTunnel Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Apache SeaTunnel</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-CN/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-CN/docs/2.1.2/intro/about">2.1.2</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.1/intro/about">2.1.1</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.0/introduction">2.1.0</a></li><li><a class="dropdown__link" href="/zh-CN/docs/1.x/introduction">1.x(Not Apache Release)</a></li><li><a class="dropdown__link" href="/zh-CN/docs/intro/about">Next</a></li><li><a class="dropdown__link" href="/zh-CN/versions/">All versions</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-CN/download">下载</a><a class="navbar__item navbar__link" href="/zh-CN/community/contribution_guide/contribute">社区</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-CN/blog">博客</a><a class="navbar__item navbar__link" href="/zh-CN/user_cases">用户案例</a><a class="navbar__item navbar__link" href="/zh-CN/team">团队</a><a class="navbar__item navbar__link" href="/zh-CN/user">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">基金会</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">证书</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">事件</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">安全</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">赞助</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">致谢</a></li></ul></div><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/blog/2022/05/31/engine" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/zh-CN/blog/2022/05/31/engine" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/Upcoming API Connector Development Analysis">Upcoming API Connector Development Analysis</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/zh-CN/blog/2022/05/31/engine">Apache SeaTunnel 与计算引擎的解耦之道，重构API我们做了些什么</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022/05/10/ClickHouse">百亿级数据同步，如何基于 SeaTunnel 的 ClickHouse 实现？</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022/05/01/_Kidswant">SeaTunnel 在孩子王的选型过程及应用改造实践</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/智能化时代的数据集成技术革新">智能化时代的数据集成技术革新</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Apache SeaTunnel 与计算引擎的解耦之道，重构API我们做了些什么</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-31T00:00:00.000Z" itemprop="datePublished">2022年5月31日</time> · <!-- -->One min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><img loading="lazy" src="/zh-CN/assets/images/0-1b0b7ccac22c107239f10a37321c7719.jpg" width="1920" height="1316"></p><p>Apache SeaTunnel (Incubating) 与 Apache Inlong (Incubating) 的5月联合Meetup中，第二位分享的嘉宾是来自白鲸开源的高级工程师李宗文。在使用Apache SeaTunnel (Incubating) 的过程中，他发现了 Apache SeaTunnel (Incubating) 存在的四大问题：Connector实现次数多、参数不统一、难以支持多个版本的引擎以及引擎升级难的问题。为了解决以上的难题，李宗文将目标放在将Apache SeaTunnel (Incubating)与计算引擎进行解耦，重构其中Source与Sink API，实现改良了开发体验。</p><p>本次演讲主要包含四个部分：</p><ol><li>Apache SeaTunnel (Incubating)<strong>重构的背景和动机</strong></li><li>Apache SeaTunnel (Incubating)<strong>重构的目标</strong></li><li>Apache SeaTunnel (Incubating)<strong>重构整体的设计</strong></li><li>Apache SeaTunnel (Incubating) <strong>Source API的设计</strong></li><li>Apache SeaTunnel (Incubating) <strong>Sink API的设计</strong></li></ol><p><img loading="lazy" src="/zh-CN/assets/images/1-cbc169e3bc121f1008b807103abe9fd8.jpg" width="1440" height="810"></p><p><strong>李宗文</strong></p><p>白鲸开源 高级工程师</p><p>Apache SeaTunnel(Incubating)</p><p>&amp; Flink Contributor, Flink CDC &amp; Debezium Contributor</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="01-重构的背景与动机"><strong>01</strong> 重构的背景与动机<a class="hash-link" href="#01-重构的背景与动机" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="01-apache-seatunnelincubating与引擎耦合">01 Apache SeaTunnel(Incubating)与引擎耦合<a class="hash-link" href="#01-apache-seatunnelincubating与引擎耦合" title="Direct link to heading">​</a></h3><p>用过Apache SeaTunnel (Incubating) 的小伙伴或者开发者应该知道，目前Apache SeaTunnel (Incubating) 与引擎完全耦合，完全基于Spark、Flink开发，其中的配置文件参数都基于Flink、Spark引擎。从贡献者和用户的角度出发，我们能发现一些问题。</p><p><strong>从贡献者的角度</strong>：反复实现Connector，没有收获感；潜在贡献者由于引擎版本不一致无法贡献社区；</p><p><strong>从用户的角度</strong>：目前很多公司采用Lambda架构，离线作业使用Spark，实时作业使用Flink， 使用中就会发现SeaTunnel 的Connector可能Spark有，但是Flink没有，以及两个引擎对于同一存储引擎的Connector的参数也不统一，有较高的使用成本，脱离了SeaTunnel简单易用的初衷；还有用户提问说目前支不支持Flink的1.14版本，按照目前SeaTunnel的架构，想要支持Flink的1.14就必须抛弃之前的版本，因此这也会对之前版本的用户造成很大的问题。</p><p>因此，我们不管是做引擎升级或者支持更多的版本的用户都很困难。</p><p>另外Spark和Flink都采用了Chandy-lamport算法实现的Checkpoint容错机制，也在内部进行了DataSet与DataStream的统一，以此为前提我们认为解耦是可行的。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="02-apache-seatunnelincubating与引擎解耦"><strong>02</strong> Apache SeaTunnel(Incubating)与引擎解耦<a class="hash-link" href="#02-apache-seatunnelincubating与引擎解耦" title="Direct link to heading">​</a></h2><p>因此为了解决以上提出的问题，我们有了以下的目标：</p><ol><li><strong>Connector只实现一次</strong>：针对参数不统一、Connector多次实现的问题，我们希望实现一个统一的Source 与Sink API;</li><li><strong>支持多个版本的Spark与Flink引擎</strong>：在Source与Sink API上再加入翻译层去支持多个版本与Spark和Flink引擎，解耦后这个代价会小很多。</li><li><strong>明确Source的分片并行逻辑和Sink的提交逻辑</strong>：我们必须提供一个良好的API去支持Connector开发；</li><li><strong>支持实时场景下的数据库整库同步</strong>：这个是目前很多用户提到<strong>需要CDC</strong>支持衍生的需求。我之前参与过Flink CDC社区，当时有许多用户提出在CDC的场景中，如果直接使用Flink CDC的话会导致每一个表都持有一个链接，当遇到需要整库同步需求时，千张表就有千个链接，该情况无论是对于数据库还是DBA都是不能接受的，如果要解决这个问题，最简单的方式就是引入Canal、Debezium等组件，使用其拉取增量数据到Kafka等MQ做中间存储，再使用Flink SQL进行同步，这实际已经违背了Flink CDC最早减少链路的想法，但是Flink CDC的定位只是一个Connector，无法做全链路的需求，所以该proposal在Flink CDC社区中没有被提出，我们借着本次重构，将proposa提交到了SeaTunnel社区中。</li><li><strong>支持元信息的自动发现与存储</strong>：这一部分用户应该有所体验，如Kafka这类存储引擎，没有记录数据结构的功能，但我们在读取数据时又必须是结构化的，导致每次读取一个topic之前，用户都必须定义topic的结构化数据类型，我们希望做到用户只需要完成一次配置，减少重复的操作。</li></ol><p>可能也有同学有疑惑为什么我们不直接使用Apache Beam，Beam的Source分为BOUNDED与UNBOUNDED，也就是需要实现两遍，并且有些Source与Sink的特性也不支持，具体所需的特性在后面会提到；</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="03-apache-seatunnelincubating重构整体的设计"><strong>03</strong> Apache SeaTunnel(Incubating)重构整体的设计<a class="hash-link" href="#03-apache-seatunnelincubating重构整体的设计" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="/zh-CN/assets/images/1-cbc169e3bc121f1008b807103abe9fd8.jpg" width="1440" height="810"></p><p>Apache SeaTunnel(Incubating) API总体结构的设计如上图；</p><p><strong>Source &amp; Sink API</strong>：数据集成的核心API之一，明确Source的分片并行逻辑和Sink的提交逻辑，用于实现Connector；</p><p><strong>Engine API</strong>：</p><p>Translation: 翻译层，用于将SeaTunnel的Souce与Sink API翻译成引擎内部可以运行的Connector；</p><p><strong>Execution</strong>：执行逻辑，用于定义Source、Transform、Sink等操作在引擎内部的执行逻辑；</p><p><strong>Table API</strong>：</p><p><strong>Table SPI</strong>：主要用于以SPI的方式暴露Source与Sink接口，并明确Connector的必填与可选参数等；</p><p><strong>DataType</strong>：SeaTunnel的数据结构，用于隔离引擎，声明Table Schema等；</p><p><strong>Catalog</strong>：用于获取Table Scheme、Options等；</p><p><strong>Catalog Storage</strong>: 用于存储用户定义Kafka等非结构化引擎的Table Scheme等；</p><p><img loading="lazy" src="/zh-CN/assets/images/2-507471aef3b2e7dc6ee4bc03188bc784.jpg" width="1440" height="810"></p><p><strong>从上图是我们现在设想的执行流程</strong>：</p><ol><li>从配置文件或UI等方式获取任务参数；</li><li>通过参数从Catalog中解析得到Table Schema、Option等信息；</li><li>以SPI方式拉起SeaTunnel的Connector，并注入Table信息等；</li><li>将SeaTunnel的Connector翻译为引擎内部的Connector；</li><li>执行引擎的作业逻辑，图中的多表分发目前只存在CDC整库同步场景下，其他Connector都是单表，不需要分发逻辑；</li></ol><p>从以上可以看出，最难的部分是<strong>如何将Apache SeaTunnel(Incubating) 的Source和Sink翻译成引擎内部的Source和Sink。</strong></p><p>当下许多用户不仅把Apache SeaTunnel (Incubating) 当做一个数据集成方向的工具，也当做数仓方向的工具，会使用很多Spark和Flink的SQL，我们目前希望能够保留这样的SQL能力，让用户实现无缝升级。</p><p><img loading="lazy" src="/zh-CN/assets/images/3-68113e215aa8e91a5d2469ccb37a3c22.jpg" width="1440" height="810"></p><p>根据我们的调研，如上图，是对Source与Sink的理想执行逻辑，由于SeaTunnel以WaterDrop孵化，所以图上的术语偏向Spark；</p><p>理想情况下，在Driver上可以运行Source和Sink的协调器，然后Worker上运行Source的Reader和Sink的Writer。在Source协调器方面，我们希望它能支持几个能力。</p><p><strong>一、是数据的分片逻辑</strong>，可以将分片动态添加到Reader中。</p><p><strong>二、是可以支持Reader的协调</strong>。SourceReader用于读取数据，然后将数据发送到引擎中流转，最终流转到Source Writer中进行数据写入，同时Writer可以支持二阶段事务提交，并由Sink的协调器支持Iceberg等Connector的聚合提交需求；</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="04-source-api"><strong>04</strong> Source API<a class="hash-link" href="#04-source-api" title="Direct link to heading">​</a></h2><p>通过我们的调研，发现Source所需要的以下特性：</p><ol><li><strong>统一离线和实时API</strong>：Source只实现一次，同时支持离线和实时；</li><li><strong>能够支持并行读取</strong>：比如Kafka每一个分区都生成一个的读取器，并行的执行；</li><li><strong>支持动态添加分片</strong>：比如Kafka定于一个topic正则，由于业务量的需求，需要新增一个topic，该Source API可以支持我们动态添加到作业中。</li><li><strong>支持协调读取器的工作</strong>：这个目前只发现在CDC这种Connector需要支持。CDC目前都是基于Netfilx的DBlog并行算法去支持，该情况在全量同步和增量同步两个阶段的切换时需要协调读取器的工作。</li><li><strong>支持单个读取器处理多张表</strong>：即由前面提到的支持实时场景下的数据库整库同步需求；</li></ol><p><img loading="lazy" src="/zh-CN/assets/images/4-ac907e3f8e305b9f6585d2171013a973.jpg" width="1440" height="810"></p><p>对应以上需求，我们做出了基础的API，如上图，目前代码以提交到Apache SeaTunnel(Incubating)的社区中api-draft分支，感兴趣的可以查看代码详细了解。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="如何适配spark和flink引擎"><strong>如何适配Spark和Flink引擎</strong><a class="hash-link" href="#如何适配spark和flink引擎" title="Direct link to heading">​</a></h3><p>Flink与Spark都在后面统一了DataSet与DataStream API，即能够支持前两个特性，那么对于剩下的3个特性：</p><ul><li>如何支持动态添加分片？</li><li>如何支持协调读取器？</li><li>如何支持单个读取器处理多张表？</li></ul><p>带着问题，进入目前的设计。</p><p><img loading="lazy" src="/zh-CN/assets/images/5-f743cf882b36bb3c383c66dec4bad95f.jpg" width="1440" height="810"></p><p>我们发现除了<strong>CDC</strong>之外，其他Connector是不需要协调器的，针对不需要协调器的，我们会有一个支持并行的Source，并进行引擎翻译。</p><p>如上图中左边是一个<strong>分片的enumerator</strong>，可以列举source需要哪些分片，有哪些分片，实时进行分片的枚举，随后将每个分片分发到真正的数据读取模块SourceReader中。<strong>对于离线与实时作业的区分使用Boundedness标记</strong>，Connector可以在分片中标记是否有停止的Offset，如Kafka可以支持实时，同时也可以支持离线。ParallelSource可以在引擎设置任意并行度，以支持并行读取。</p><p><img loading="lazy" src="/zh-CN/assets/images/6-ef5d53449db28f4466c14827335d07a6.jpg" width="1440" height="810"></p><p>在需要协调器的场景，如上图，需要在Reader和Enumerator之间进行Event传输，<strong> Enumerator</strong>通过Reader发送的Event进行协调工作。<strong>Coordinated Source</strong>需要在引擎层面保证单并行度，以保证数据的一致性；当然这也不能良好的使用引擎的内存管理机制，但是取舍是必要的；</p><p><strong>对于最后一个问题，我们如何支持单个读取器处理多张表。这会涉及到Table API层</strong>，通过Catalog读取到了所有需要的表后，有些表可能属于一个作业，可以通过一个链接去读取，有些可能需要分开，这个依赖于Source是怎么实现的。基于这是一个特殊需求，我们想要减少普通开发者的难度，在Table API这一层，我们会提供一个SupportMultipleTable接口，用于声明Source支持多表的读取。Source在实现时，要根据多张表实现对应的反序列化器。针对衍生的多表数据如何分离，Flink将采用Side Output机制，Spark预想使用Filter或Partition机制。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="05-sink-api"><strong>05</strong> Sink API<a class="hash-link" href="#05-sink-api" title="Direct link to heading">​</a></h2><p>目前Sink所需的特性并不是很多，<strong>经过调研目前发现有三个需求</strong>：</p><ol><li>幂等写入，这个不需要写代码，主要看存储引擎是否能支持。</li><li>分布式事务，主流是二阶段提交，如Kafka都是可以支持分布式事务的。</li><li>聚合提交，对于Iceberg、hoodie等存储引擎而言，我们不希望有小文件问题，于是期望将这些文件聚合成一个文件，再进行提交。</li></ol><p>基于以上三个需求，我们有对应的<strong>三个API</strong>，分别是<strong>SinkWriter、SinkCommitter、SinkAggregated Committer</strong>。SinkWriter是作为基础写入，可能是幂等写入，也可能不是。SinkCommitter支持二阶段提交。SinkAggregatedCommitter支持聚合提交。</p><p><img loading="lazy" src="/zh-CN/assets/images/7-e9830d63f81f7139a7cd1d4d9b9f5e43.jpg" width="1440" height="810"></p><p>理想状态下，<strong>AggregatedCommitter</strong>单并行的在Driver中运行，Writer与Committer运行在Worker中，可能有多个并行度，每个并行度都有自己的预提交工作，然后把自己提交的信息发送给Aggregated Committer再进行聚合。</p><p><strong>目前Spark和Flink的高版本都支持在Driver</strong>(Job Manager)运行AggregatedCommitter，worker(Job Manager)运行writer和Committer。</p><p><img loading="lazy" src="/zh-CN/assets/images/8-aa0537c76d15543b46623445ff00e490.jpg" width="1440" height="810"></p><p>但是对于<strong>Flink低版本</strong>，无法支持AggregatedCommitter在JM中运行，我们也进行翻译适配的设计。Writer与Committer会作为前置的算子，使用Flink的ProcessFunction进行包裹，支持并发的预提交与写入工作，基于Flink的Checkpoint机制实现二阶段提交，这也是目前Flink的很多Connector的2PC实现方式。这个ProcessFunction会将预提交信息发送到下游的Aggregated Committer中，Aggregated Committer可以采用SinkFunction或Process Function等算子包裹，当然，<strong>我们需要保证AggregatedCommitter只会启动一个，即单并行度</strong>，否则聚合提交的逻辑就会出现问题。</p><p>感谢各位的观看，如果大家对具体实现感兴趣，可以去 Apache SeaTunnel (Incubating) 的社区查看<strong>api-draft</strong>分支代码，谢谢大家。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh-CN/blog/Upcoming API Connector Development Analysis"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Upcoming API Connector Development Analysis</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh-CN/blog/2022/05/10/ClickHouse"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">百亿级数据同步，如何基于 SeaTunnel 的 ClickHouse 实现？</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#01-重构的背景与动机" class="table-of-contents__link toc-highlight"><strong>01</strong> 重构的背景与动机</a><ul><li><a href="#01-apache-seatunnelincubating与引擎耦合" class="table-of-contents__link toc-highlight">01 Apache SeaTunnel(Incubating)与引擎耦合</a></li></ul></li><li><a href="#02-apache-seatunnelincubating与引擎解耦" class="table-of-contents__link toc-highlight"><strong>02</strong> Apache SeaTunnel(Incubating)与引擎解耦</a></li><li><a href="#03-apache-seatunnelincubating重构整体的设计" class="table-of-contents__link toc-highlight"><strong>03</strong> Apache SeaTunnel(Incubating)重构整体的设计</a></li><li><a href="#04-source-api" class="table-of-contents__link toc-highlight"><strong>04</strong> Source API</a><ul><li><a href="#如何适配spark和flink引擎" class="table-of-contents__link toc-highlight"><strong>如何适配Spark和Flink引擎</strong></a></li></ul></li><li><a href="#05-sink-api" class="table-of-contents__link toc-highlight"><strong>05</strong> Sink API</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">SeaTunnel</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/faq">FAQ</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>版本<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Pull Requests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">订阅邮件组</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/community/contribution_guide/subscribe">How to Subscribe</a></li><li class="footer__item"><a href="mailto:dev-subscribe@seatunnel.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>订阅邮件<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@seatunnel.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>邮件归档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div style="margin-top: 20px;background: #f4f8fa">
                <img style="height:50px;margin-bottom: 10px" alt="Apache Software Foundation" src="/zh-CN/image/incubator-logo.svg">
                <p style="color: #999999;font-weight:400;text-align:left">Apache SeaTunnel is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
                <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright © 2021-2022 The Apache Software Foundation. Apache SeaTunnel, SeaTunnel, and its feather logo are trademarks of The Apache Software Foundation.</span></div>
                <div style="text-align: center;">
                    <a href="https://twitter.com/asfseatunnel?s=21" target="_blank" title="Twitter"><svg t="1644553365083" class="icon" viewBox="0 0 1260 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7015" width="25" height="25"><path d="M1259.846921 121.148242c-46.524504 20.728739-96.273478 34.547899-148.325646 40.536201 53.434084-31.784067 94.430924-82.454319 113.777747-142.797982-50.209613 29.480874-105.486251 51.13089-164.447999 62.646857A257.584528 257.584528 0 0 0 872.449815 0.000276c-142.797982 0-258.418284 115.620302-258.418284 258.418284 0 20.268101 2.303193 40.075563 6.909579 58.961748C405.82286 306.32498 215.579097 203.602561 87.98219 47.446058c-22.110655 38.233008-35.008538 82.454319-35.008538 129.900099 0 89.824537 45.603227 168.593747 115.159663 215.118251-42.378756-1.381916-81.99368-12.897882-117.002217-32.244706v3.224471c0 125.293713 88.90326 229.398049 207.287393 253.351259-21.650017 5.988302-44.681949 9.212773-68.17452 9.212773-16.582991 0-32.705344-1.842555-48.827697-4.606387 32.705344 102.722419 128.518184 177.345881 241.374653 179.649074-88.442621 69.095798-199.917175 110.553277-321.06514 110.553277-20.728739 0-41.457479-1.381916-61.72558-3.685109 114.238386 73.241546 250.126788 116.08094 396.149241 116.08094 475.379089 0 735.179289-393.846048 735.179289-735.179289 0-11.055328-0.460639-22.571294-0.921277-33.626621 51.13089-36.851092 94.891562-82.454319 129.439461-134.045848z" fill="#909094" p-id="7016"></path></svg></a> 
                    <a href="https://apacheseatunnel.slack.com" target="_blank" title="Slack" style="margin-left: 20px;"><svg t="1644553076784" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3088" width="23" height="23"><path d="M215.125333 647.04a107.861333 107.861333 0 0 1-107.52 107.648A107.861333 107.861333 0 0 1 0 647.04a107.818667 107.818667 0 0 1 107.605333-107.52h107.52v107.52z m54.229334 0a107.818667 107.818667 0 0 1 107.562666-107.52 107.818667 107.818667 0 0 1 107.562667 107.52v269.354667A107.861333 107.861333 0 0 1 376.917333 1024a107.861333 107.861333 0 0 1-107.562666-107.605333v-269.354667zM376.917333 215.125333a107.861333 107.861333 0 0 1-107.562666-107.52A107.861333 107.861333 0 0 1 376.917333 0a107.861333 107.861333 0 0 1 107.562667 107.605333v107.52H376.917333z m0 54.229334a107.861333 107.861333 0 0 1 107.562667 107.562666 107.861333 107.861333 0 0 1-107.562667 107.562667H107.605333A107.861333 107.861333 0 0 1 0 376.917333a107.861333 107.861333 0 0 1 107.605333-107.562666h269.312z m431.872 107.562666a107.861333 107.861333 0 0 1 107.605334-107.562666A107.861333 107.861333 0 0 1 1024 376.917333a107.861333 107.861333 0 0 1-107.605333 107.562667h-107.605334V376.917333z m-54.101333 0a107.861333 107.861333 0 0 1-107.648 107.562667 107.818667 107.818667 0 0 1-107.52-107.562667V107.605333A107.818667 107.818667 0 0 1 647.04 0a107.861333 107.861333 0 0 1 107.648 107.605333v269.312z m-107.648 431.872a107.861333 107.861333 0 0 1 107.648 107.605334A107.861333 107.861333 0 0 1 647.04 1024a107.818667 107.818667 0 0 1-107.52-107.605333v-107.605334h107.52z m0-54.101333a107.818667 107.818667 0 0 1-107.52-107.648 107.776 107.776 0 0 1 107.52-107.52h269.354667A107.818667 107.818667 0 0 1 1024 647.04a107.861333 107.861333 0 0 1-107.605333 107.648h-269.354667z" p-id="3089" fill="#909094"></path></svg></a> 
                    <a href="https://lists.apache.org/list.html?dev@seatunnel.apache.org" target="_blank" title="Mailing list" style="margin-left: 20px;"><svg t="1644553175467" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5304" width="26" height="26"><path d="M853.333333 170.666667H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333333v512c0 46.933333 38.4 85.333333 85.333334 85.333333h682.666666c46.933333 0 85.333333-38.4 85.333334-85.333333V256c0-46.933333-38.4-85.333333-85.333334-85.333333z m0 170.666666l-341.333333 213.333334-341.333333-213.333334V256l341.333333 213.333333 341.333333-213.333333v85.333333z" p-id="5305" fill="#909094"></path></svg></a> 
                    <a href="https://github.com/apache/incubator-seatunnel" target="_blank" title="GitHub" style="margin-left: 20px;"><svg t="1644553223000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6156" width="23" height="23"><path d="M512 12.64c-282.752 0-512 229.216-512 512 0 226.208 146.72 418.144 350.144 485.824 25.6 4.736 35.008-11.104 35.008-24.64 0-12.192-0.48-52.544-0.704-95.328-142.464 30.976-172.512-60.416-172.512-60.416-23.296-59.168-56.832-74.912-56.832-74.912-46.464-31.776 3.52-31.136 3.52-31.136 51.392 3.616 78.464 52.768 78.464 52.768 45.664 78.272 119.776 55.648 148.992 42.56 4.576-33.088 17.856-55.68 32.512-68.48-113.728-12.928-233.28-56.864-233.28-253.024 0-55.904 20-101.568 52.768-137.44-5.312-12.896-22.848-64.96 4.96-135.488 0 0 43.008-13.76 140.832 52.48a491.296 491.296 0 0 1 128.16-17.248c43.488 0.192 87.328 5.888 128.256 17.248 97.728-66.24 140.64-52.48 140.64-52.48 27.872 70.528 10.336 122.592 5.024 135.488 32.832 35.84 52.704 81.536 52.704 137.44 0 196.64-119.776 239.936-233.792 252.64 18.368 15.904 34.72 47.04 34.72 94.816 0 68.512-0.608 123.648-0.608 140.512 0 13.632 9.216 29.6 35.168 24.576C877.472 942.624 1024 750.784 1024 524.64c0-282.784-229.248-512-512-512z" p-id="6157" fill="#909094"></path></svg></a> 
                </div>
            <div></div></div></div></div></div></footer></div>
<script src="/zh-CN/assets/js/runtime~main.b2c68a42.js"></script>
<script src="/zh-CN/assets/js/main.63c98135.js"></script>
</body>
</html>